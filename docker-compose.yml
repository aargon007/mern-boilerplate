version: "3.8"

services:
  # Backend Server
  server:
    build:
      context: .
      dockerfile: apps/server/Dockerfile
    container_name: mern-turbo-server
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${PORT:-5000}
      DB_URI: ${DB_URI}
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET:-your-super-secret-jwt-access-key}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-your-super-secret-jwt-refresh-key}
      JWT_ACCESS_EXPIRES_IN: ${JWT_ACCESS_EXPIRES_IN:-15m}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-7d}
      BCRYPT_SALT_ROUNDS: ${BCRYPT_SALT_ROUNDS:-12}
      CLIENT_ORIGIN: ${CLIENT_ORIGIN:-http://localhost:3000}
    ports:
      - "5000:5000"
    networks:
      - mern-turbo-network
    volumes:
      - ./logs:/app/logs

  # Frontend Application
  frontend:
    build:
       context: .
       dockerfile: apps/frontend/Dockerfile
    container_name: mern-turbo-frontend
    restart: unless-stopped
    environment:
      VITE_BASE_API: ${VITE_BASE_API:-http://localhost:5000/api/v1}
    ports:
      - "3000:3000"
    depends_on:
      - server
    networks:
      - mern-turbo-network

  # Nginx Reverse Proxy (Optional)
  nginx:
    image: nginx:alpine
    container_name: mern-turbo-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend
      - server
    networks:
      - mern-turbo-network

networks:
  mern-turbo-network:
    driver: bridge
